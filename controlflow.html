<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mario Kart 64: Codebase Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Mario Kart 64
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('controlflow.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Codebase Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md25">Paradigm</a></li>
<li class="level1"><a href="#autotoc_md26">Threading</a></li>
<li class="level1"><a href="#autotoc_md27">Overall Control Flow</a></li>
<li class="level1"><a href="#autotoc_md28">Segments</a></li>
<li class="level1"><a href="#autotoc_md29">Code Breakdown</a><ul><li class="level2"><a href="#autotoc_md30">Players</a></li>
<li class="level2"><a href="#autotoc_md31">Actors</a></li>
<li class="level2"><a href="#autotoc_md32">Objects</a></li>
<li class="level2"><a href="#autotoc_md33">Courses</a><ul><li class="level3"><a href="#autotoc_md34">Course Folder</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md35">UI &amp; Other 2D Screen data</a></li>
<li class="level2"><a href="#autotoc_md36">Engine</a></li>
<li class="level2"><a href="#autotoc_md37">Math</a></li>
<li class="level2"><a href="#autotoc_md38">Ending</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="autotoc_md25"></a>
Paradigm</h1>
<p>The developers wrote mk64 using a state-driven paradigm. Gamestate, gamemode, course, actors, structs, and more decide which branches code should follow. As an example, a condition can check the current course to load that courses resources or run logic based on that.</p>
<h1><a class="anchor" id="autotoc_md26"></a>
Threading</h1>
<p>After boot, the game begins by setting up its four threads; idle, video, audio, and the game loop. The idle thread allows the cpu to sleep. Without it, if at any time execution of all threads were paused, the cpu would never be able to continue. The idle thread is active if all the other threads are paused.</p>
<p>As such, the idle thread runs the following loop: <code>while(TRUE);</code> (it runs in a perpetual loop of nothing; sleep). In mips assembly it looks like this: </p><div class="fragment"><div class="line">.L800005B8:</div>
<div class="line">b     .L800005B8</div>
<div class="line">nop   </div>
</div><!-- fragment --><p> b stands for branch which acts akin to a goto. In this case, branch to the label <code>.L800005B8</code>. This creates an infinite loop. Whenever the cpu branches it always runs the next instruction as well which is called a delay slot. This means the cpu will continuously branch then run <code>nop</code> or <code>no operation</code> with no method of escaping the loop (except for when another thread has a higher priority which means the cpu switches to that thread and stops running the idle thread).</p>
<p>N64 threads are ran based on priority running whichever thread holds the most of it. Threads can also pause and wait for events. <a class="el" href="structNote.html">Note</a> that the N64 is not multi-threaded by modern standards as the other threads contain specific purposes which slightly differs from the concept of splitting a single program into multiple processes for efficiency.</p>
<h1><a class="anchor" id="autotoc_md27"></a>
Overall Control Flow</h1>
<div class="fragment"><div class="line">init_threads:</div>
<div class="line">  idle, video, audio, gameloop</div>
<div class="line">gameloop:</div>
<div class="line">  audio</div>
<div class="line">  jumpTo a specific menu or race based on a gameState flag.</div>
<div class="line">  profiler</div>
<div class="line">  config_gfx_pool</div>
<div class="line">  read_controllers</div>
<div class="line">  game_state_controller</div>
<div class="line">  endDL/vsync</div>
<div class="line">game_state_controller:</div>
<div class="line">  switch(loc)</div>
<div class="line">     menus -&gt; switch(menu) { // do menu stuff }</div>
<div class="line">     race_logic_loop -&gt; spaghetti</div>
<div class="line">     podium_ceremony</div>
<div class="line">     credits</div>
<div class="line">video:</div>
<div class="line">  handles interaction between video/audio threads.</div>
<div class="line">  handles vblanking and some elements pertaining to framebuffer</div>
<div class="line">  most of all, handles which step of rendering a frame the cpu is in.</div>
<div class="line">  Checks when new to start new sp tasks</div>
</div><!-- fragment --><p> If mk64 is in a menu state it will branch off to the menu code, running relevant bits of code based on more flags such as which particular menu the user is in. This will loop until the state changes to a different one such as race mode. If mk64 is in a race state, then race related code is ran and it spaghetti's off into a wide series of branches. This may include concepts such as <code>isLinedUp, isRacing, isRaceFinished, gotoNextCourse, isHuman, and isAI</code>.</p>
<p>This relatively primitive design could be defined as a state machine from an abstract point of view. This would differ from an OOP design that uses objects and hierarchy. You will become very familiar with this design principle as you explore the code-base. During any step of the game loop, a switch can be setup to check a flag then run code relevant to the situation. For instance, a flag can check whether a race is in-progress or complete. If in-progress set the player to human controlled. If complete, set player to AI controlled.</p>
<h1><a class="anchor" id="autotoc_md28"></a>
Segments</h1>
<p>mk64 code is split into three sections </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Segment   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Main   </td><td class="markdownTableBodyNone">Menus, audio, libultra, rsp    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Racing   </td><td class="markdownTableBodyNone">Memory management, courses, players, actors, skybox, collision, math    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Ending   </td><td class="markdownTableBodyNone">Podium ceremony, credits   </td></tr>
</table>
<p>Racing segment loads after selecting a grand prix. <a class="el" href="structNote.html">Note</a> that it is always reloaded preventing randomization of cpu's at the start of the first race due to no time for the random seed to actually become random.</p>
<h1><a class="anchor" id="autotoc_md29"></a>
Code Breakdown</h1>
<h2><a class="anchor" id="autotoc_md30"></a>
Players</h2>
<p><a class="el" href="structPlayer.html">Player</a> related code resides in </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">file   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="player__controller_8c.html">player_controller.c</a>   </td><td class="markdownTableBodyNone">Applies physics to players    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="camera_8c.html">camera.c</a>   </td><td class="markdownTableBodyNone"><a class="el" href="structPlayer.html">Player</a> cameras   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md31"></a>
Actors</h2>
<p><a class="el" href="structActor.html">Actor</a> related code resides in </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">file   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="actors_8c.html">actors.c</a>   </td><td class="markdownTableBodyNone">Variety of <a href="actorsmenu.html">actors</a>, see link for specifics.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="actors__extended_8c.html">actors_extended.c</a>   </td><td class="markdownTableBodyNone">Shells and bananas   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md32"></a>
Objects</h2>
<p>Object related code resides in </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">file   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="code__80057C60_8c.html">code_80057C60.c</a>   </td><td class="markdownTableBodyNone"><a class="el" href="structObjects.html">Objects</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="code__80071F00_8c.html">code_80071F00.c</a>   </td><td class="markdownTableBodyNone"><a class="el" href="structObjects.html">Objects</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="code__80086E70_8c.html">code_80086E70.c</a>   </td><td class="markdownTableBodyNone"><a class="el" href="structObjects.html">Objects</a>   </td></tr>
</table>
<p>Documentation of the specifics still in-progress. See <a href="actorsmenu.html">actors</a> for more information.</p>
<h2><a class="anchor" id="autotoc_md33"></a>
Courses</h2>
<p>Course related code resides in </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">file   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="memory_8c.html">memory.c</a>   </td><td class="markdownTableBodyNone">Loads and extracts course data    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="render__courses_8c.html">render_courses.c</a>   </td><td class="markdownTableBodyNone">Renders course content    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="common__textures_8inc_8c.html">common_textures.inc.c</a>   </td><td class="markdownTableBodyNone">Content accessible to every course such as items and portraits   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md34"></a>
Course Folder</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">file   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">courses/course_name/course_data.inc.c   </td><td class="markdownTableBodyNone">Course data    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">courses/course_name/course_vertices.inc.c   </td><td class="markdownTableBodyNone">Course vertices (this + _displaylists.inc.c makes the course geography)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">courses/course_name/course_displaylists.inc.c   </td><td class="markdownTableBodyNone">Course displaylists (these get compressed during compile)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">courses/course_name/course_offsets.inc.c   </td><td class="markdownTableBodyNone">Textures used in the course   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md35"></a>
UI &amp; Other 2D Screen data</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">file   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="hud__renderer_8c.html">hud_renderer.c</a>   </td><td class="markdownTableBodyNone">ItemWindows   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md36"></a>
Engine</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">file   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="collision_8c.html">collision.c</a>   </td><td class="markdownTableBodyNone"></td></tr>
</table>
<h2><a class="anchor" id="autotoc_md37"></a>
Math</h2>
<p>Math related code resides in </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">file   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="math__util_8c.html">math_util.c</a>   </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="math__util__2_8c.html">math_util_2.c</a>   </td><td class="markdownTableBodyNone"></td></tr>
</table>
<h2><a class="anchor" id="autotoc_md38"></a>
Ending</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">file   </th><th class="markdownTableHeadNone">desc    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="ceremony__and__credits_8c.html">ceremony_and_credits.c</a>   </td><td class="markdownTableBodyNone"><a class="el" href="structCamera.html">Camera</a> rails for podium ceremony and credits    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="podium__ceremony__actors_8c.html">podium_ceremony_actors.c</a>   </td><td class="markdownTableBodyNone">Fireworks and balloons for podium ceremony    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="ceremony__data_8inc_8c.html">ceremony_data.inc.c</a>   </td><td class="markdownTableBodyNone">Trophies and podium models. Paths.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="credits_8c.html">credits.c</a>   </td><td class="markdownTableBodyNone">Credits text and UI positions   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="basics.html">Understanding the Basics</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
